# Architecture

This document describes the most important architecture decisions in Franz-go. Reading this document should
help you to understand how this library is supposed to be used.

Franz-go consists of multiple Go packages where each serves it's own purpose (for example SASL authentication) but
they are designed to be used together. These packages are describe below.

## Package kgo

The package `kgo` is the main package as it provides all the core functionality to interact with Kafka. 
It has support for transactions, regex topic consuming, the latest partitioning strategies, data loss detection,
closest replica fetching, and more. If a client [KIP][1] exists, this library aims to support it.

[1]: https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Improvement+Proposals

This library attempts to provide an intuitive API _while_ interacting with Kafka
the way Kafka expects (timeouts, etc.). In some cases, this makes the tricky
corners of Kafka more explicit and manual to deal with correctly. In the general
case, though, I hope this library is satisfactory.

## Package kmsg

The main package is `kgo`, but `kmsg` also exists containing autogenerated code for every request and
response type. `kmsg` mostly implements the messages as defined in the Kafka protocol. You will often want to use
this package if you need more control how to access Kafka. A common use case is constructing
and sending admin api requests.

Usage:

```go
req := kmsg.MetadataRequest{
    Topics: []kmsg.MetadataRequestTopic{},
}

res, err := req.RequestWith(ctx, client)
if err != nil {
    // Error during request has happened (e. g. context cancelled)
    panic(err)
}
```

## Package sasl

Package `sasl` specifies interfaces that any sasl authentication (PLAIN, GSSAPI, SCRAM, ...) must provide to 
interop with Kafka SASL. This package is more specific to SASL and not to Kafka, hence it has it's own package.

Usage:

```go
seeds := []string{"localhost:9092"}

// SASL Plain credentials
user := ""
password := ""

opts := []kgo.Opt{
    kgo.SeedBrokers(seeds...),
    // SASL Options
    kgo.SASL(plain.Auth{
        User: user,
        Pass: password,
    }.AsMechanism()),
}
client, err := kgo.NewClient(opts...)
```

## Package kversion

Package kversion specifies max versions for Kafka request keys. Kafka technically has internal broker versions
that bump multiple times per release. This package only defines releases and tip. You usually use this to set the
max version that shall be used for requests that will be sent to Kafka.

Setting a max version (rather than the default that uses the latest available Kafka version) is important because newer 
versions may require additional fields to be set in the request. If you use the `kmsg` package, updates could then
cause breaking changes.

Usage:

```go
client, err := kgo.NewClient(
    kgo.SeedBrokers(seeds...),
    kgo.MaxVersions(kversion.V2_4_0()),
)
```

## Package kerr

Package kerr is dedicated to all Kafka errors. Some responses such as responses to bulk requests like Broker configs
that shall be described, contain error codes. The `kerr` package allows to construct actual errors with a proper
error message using the given error code.

Usage:

```go
err := kerr.ErrorForCode(response.ErrorCode)
if err != nil {
    // Handle error
}
```
