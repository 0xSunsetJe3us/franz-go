kmsg
====

kmsg is a repo containing Kafka message types and autogenerated encode/decode
functions for those types.

The intent of this repo is to provide a base for other projects to build on top
of.

The `messages` file is the base that all code is generated from. The format of
the file is strict; the parser minimally implemented and will not handle any
errors.

How it works
------------

This code heavily relies on scoped variables and shadowing. There are a few
known primitive types, and these have defined append and parse functions
in kmsg/primitives.go. All other types build on top of this.

All variables use the variable `v` for modifying. Arrays and structs copy their
current `v` to other variables (`a`, `s`) so that they can work appropriately
as types further down the type tree use their own local `v` variable.

All appends for encoding use the same `dst` variable, and all reads for
decoding use a special `binreader` that has primitive parsing functions.
That `binreader` also keeps an error internally so that a parse function
is easy to define: keep parsing, if an error happened a parse will no-op.

messages format
---------------

Each non-empty, non-space-nor-slash beginning line begins a new, top level
struct. The only exceptions to this are `Header`, `Record`, and `RecordBatch`,
which are special definitions underneath an overarching "nullable bytes" inside
of a `ProduceRequest`. These exceptions are not considered top level and do
not have encode/decode functions generated.

Top level types can refer to the prior type that they are the response to the
prior type's request, or they can have a min/max/key specification. This all
follows the first `=>`.

Each line after `=>` is a field. Fields names end in a colon and then the type
follows. Types surrounded with brackets are arrays, and a nested struct is
defined with simply another `=>`. An array of structs is `[=>]`.

If a field type refers to a non-primitive, the type must have been defined
earlier in the file.

Fields that end with a ` // v` specify the version that a field was added.
` // v3+` means all versions above version 3 have the field.

Comments are lines beginning with two slashes and belong to the field
that will follow.

Fields must have two spaces for each level it is inside of a struct.

The generated code is _very_ ugly but the generation is also _very_ simple.

The defined primitive types are `bool`, `int8`, `int16`, `int32`, `int64`,
`uint32`, `varint`, `varlong`, `string`, `nullable-string`, `bytes`,
`nullable-bytes`, `varint-string`, and `varint-bytes`.
